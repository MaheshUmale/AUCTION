<!DOCTYPE html>
<html>
<head>
    <title>Trading Dashboard</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <h1>Real-Time Trading Dashboard</h1>
    <div id="chart" style="width: 800px; height: 600px;"></div>

    <script>
        const chartContainer = document.getElementById('chart');
        const chart = LightweightCharts.createChart(chartContainer, {
            width: 800,
            height: 600,
            layout: {
                backgroundColor: '#ffffff',
                textColor: 'rgba(33, 56, 77, 1)',
            },
            grid: {
                vertLines: {
                    color: 'rgba(197, 203, 206, 0.5)',
                },
                horzLines: {
                    color: 'rgba(197, 203, 206, 0.5)',
                },
            },
            crosshair: {
                mode: LightweightCharts.CrosshairMode.Normal,
            },
            rightPriceScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
            },
            timeScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
            },
        });

        const candleSeries = chart.addCandlestickSeries({
            upColor: 'rgba(0, 150, 136, 1)',
            downColor: 'rgba(255, 82, 82, 1)',
            borderDownColor: 'rgba(255, 82, 82, 1)',
            borderUpColor: 'rgba(0, 150, 136, 1)',
            wickDownColor: 'rgba(255, 82, 82, 1)',
            wickUpColor: 'rgba(0, 150, 136, 1)',
        });

        const ws = new WebSocket("ws://localhost:8000/ws");

        ws.onopen = function(event) {
            console.log("WebSocket connection established.");
        };

        ws.onmessage = function(event) {
            console.log("Received data:", event.data);
            const data = JSON.parse(event.data);
            const feeds = data.feeds;
            for (const symbol in feeds) {
                const feed = feeds[symbol];
                const market = feed.fullFeed.marketFF || feed.fullFeed.indexFF;
                if (market && market.marketOHLC) {
                    const ohlcList = market.marketOHLC.ohlc;
                    ohlcList.forEach(ohlc => {
                        if (ohlc.interval === 'I1') {
                            const candleData = {
                                time: ohlc.ts / 1000, // Convert ms to seconds
                                open: ohlc.open,
                                high: ohlc.high,
                                low: ohlc.low,
                                close: ohlc.close,
                            };
                            console.log("Updating chart with:", candleData);
                            candleSeries.update(candleData);
                        }
                    });
                }
            }
        };

        ws.onerror = function(event) {
            console.error("WebSocket error observed:", event);
        };
    </script>
</body>
</html>
